apiVersion: v1
kind: ConfigMap
metadata:
  name: flyway-sql
data:
  V1__create_users.sql: |
    CREATE TABLE IF NOT EXISTS users (
      id          BIGINT PRIMARY KEY AUTO_INCREMENT,
      public_id   VARCHAR(64)   NOT NULL UNIQUE,
      username    VARCHAR(255)  NOT NULL UNIQUE,
      email       VARCHAR(255)  NOT NULL UNIQUE,
      password    VARCHAR(255)  NOT NULL,
      status      VARCHAR(32)   NOT NULL,
      roles       VARCHAR(255)  NOT NULL,
      created_at  DATETIME(6)   NOT NULL DEFAULT CURRENT_TIMESTAMP(6),
      updated_at  DATETIME(6)   NOT NULL DEFAULT CURRENT_TIMESTAMP(6) ON UPDATE CURRENT_TIMESTAMP(6),
      INDEX       idx_username (username)
    ) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci;
  V2__create_email_token.sql: |
    CREATE TABLE IF NOT EXISTS mail_tokens (
      id         BIGINT PRIMARY KEY AUTO_INCREMENT,
      user_id    BIGINT            NOT NULL,
      token      VARCHAR(128)      NOT NULL UNIQUE,
      email      VARCHAR(255)      NOT NULL,
      username   VARCHAR(255)      NOT NULL,
      expires_at DATETIME(6)       NOT NULL,
      used       BOOLEAN           NOT NULL DEFAULT FALSE,
      created_at DATETIME(6)       NOT NULL DEFAULT CURRENT_TIMESTAMP(6),

      INDEX idx_mail_token_user (username),
      INDEX idx_mail_token_email (email),

      CONSTRAINT fk_mail_tokens_user
          FOREIGN KEY (user_id) REFERENCES users(id)
          ON DELETE CASCADE
    ) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci;
  V3__refresh_tokens.sql: |
    CREATE TABLE IF NOT EXISTS refresh_tokens (
      id            BIGINT PRIMARY KEY AUTO_INCREMENT,
      username      VARCHAR(255)  NOT NULL,
      token         VARCHAR(255)  NOT NULL UNIQUE,
      device_id     VARCHAR(128)  NOT NULL,
      ip_address    VARCHAR(45),
      created_at    DATETIME(6)   NOT NULL DEFAULT CURRENT_TIMESTAMP(6),
      expires_at    DATETIME(6)   NOT NULL,
      revoked       BOOLEAN       NOT NULL DEFAULT FALSE,

      UNIQUE KEY uk_user_device (username, device_id),
      INDEX idx_token (token),
      INDEX idx_user (username)
    ) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci;