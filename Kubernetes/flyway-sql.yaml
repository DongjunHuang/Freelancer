apiVersion: v1
kind: ConfigMap
metadata:
  name: flyway-sql
data:
  V1__create_users.sql: |
    CREATE TABLE users (
      id          BIGINT PRIMARY KEY AUTO_INCREMENT,
      public_id   VARCHAR(64)   NOT NULL UNIQUE,
      username    VARCHAR(255)  NOT NULL UNIQUE,
      email       VARCHAR(255)  NOT NULL UNIQUE,
      password    VARCHAR(255)  NOT NULL,
      status      VARCHAR(32)   NOT NULL,
      created_at  TIMESTAMP(6)  NOT NULL DEFAULT CURRENT_TIMESTAMP(6),
      updated_at  TIMESTAMP(6)  NOT NULL DEFAULT CURRENT_TIMESTAMP(6) ON UPDATE CURRENT_TIMESTAMP(6)
    ) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4;
  V2__create_email_token.sql: |
    CREATE TABLE IF NOT EXISTS mail_tokens (
      id         BIGINT PRIMARY KEY AUTO_INCREMENT,
      user_id    BIGINT       NOT NULL,
      token      VARCHAR(128) NOT NULL UNIQUE,                 -- 只保证 token 唯一
      email      VARCHAR(255) NOT NULL,
      username   VARCHAR(255) NOT NULL,
      expires_at DATETIME(6)  NOT NULL,
      used       BOOLEAN      NOT NULL DEFAULT FALSE,
      created_at DATETIME(6)  NOT NULL DEFAULT CURRENT_TIMESTAMP(6),
      INDEX idx_mail_token_user      (user_id),
      INDEX idx_mail_token_expires   (expires_at)
    ) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4;
  V3__refresh_tokens.sql: |
    CREATE TABLE IF NOT EXISTS refresh_tokens (
      id          BIGINT PRIMARY KEY AUTO_INCREMENT,                
      username    VARCHAR(255) NOT NULL,                       
      token       VARCHAR(255) NOT NULL UNIQUE,                  
      expire_at   DATETIME(6) NOT NULL,                    
      created_at  TIMESTAMP(6) NOT NULL DEFAULT CURRENT_TIMESTAMP(6), 
      INDEX idx_refresh_user (username),                   
      INDEX idx_refresh_token (token)                    
    );