name: CI/CD to VPS

on:
  workflow_dispatch:
  
jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      # 1. Fetch the source code 
      - name: Checkout
        uses: actions/checkout@v4

      # 2. Set up SSH private key
      - name: Set up SSH agent
        uses: webfactory/ssh-agent@v0.9.0
        with:
          ssh-private-key: ${{ secrets.SSH_PRIVATE_KEY }}
      
      # 3. Add VPS address to the host
      - name: Add VPS to known_hosts
        run: |
          mkdir -p ~/.ssh
          ssh-keyscan -p "${{ secrets.VPS_PORT }}" "${{ secrets.VPS_HOST }}" >> ~/.ssh/known_hosts
      
      # 4. direct secrets into the env
      - name: Replace environment variables in secrets.yaml
        run: |
          envsubst < k8s/secrets.yaml > k8s/secrets.resolved.yaml
        env:
          MYSQL_DATABASE: ${{ secrets.MYSQL_DATABASE }}
          MYSQL_USER: ${{ secrets.MYSQL_USER }}
          MYSQL_PASSWORD: ${{ secrets.MYSQL_PASSWORD }}
          MYSQL_ROOT_PASSWORD: ${{ secrets.MYSQL_ROOT_PASSWORD }}

      # 2) 用 envsubst 将应用清单里的镜像/变量替换
      - name: Render app manifest
        run: |
          export IMAGE="$REGISTRY/$IMAGE_NAME:$TAG"
          envsubst < k8s/Freelancer-app.yaml > k8s/_app.resolved.yaml

      #  （如果 mysql 清单也有变量占位符，同样处理）
      - name: Render mysql manifest
        run: |
          envsubst < k8s/Freelancer-mysql.yaml > k8s/_mysql.resolved.yaml
        env:
          MYSQL_DATABASE: ${{ secrets.MYSQL_DATABASE }}
          MYSQL_USER: ${{ secrets.MYSQL_USER }}
          MYSQL_PASSWORD: ${{ secrets.MYSQL_PASSWORD }}
          MYSQL_ROOT_PASSWORD: ${{ secrets.MYSQL_ROOT_PASSWORD }}

      - name: Apply Kubernetes manifests
        run: |
          kubectl apply -f k8s/secrets.resolved.yaml
          kubectl apply -f k8s/Freelancer-mysql.yaml
          kubectl apply -f k8s/Freelancer-app.yaml

